
<!DOCTYPE html>
<html lang="zh-CN">
<head>
 <meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
<meta HTTP-EQUIV="pragma" CONTENT="no-cache">
<meta HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">
<meta HTTP-EQUIV="expires" CONTENT="0">
<meta name="author" content="bwrong, wang11535041@qq.com"/>
<meta name="keywords" content="【前端工程化】篇五 未来已来-Babel | BWrong的小站,前端,krpano,js,vue"/>
<meta name="description" content="天青色等烟雨，而我在等你"/>
<!-- <title>【前端工程化】篇五 未来已来-Babel | BWrong的小站</title> -->
<title>网站搭建测试</title>
<link href="https://www.bwrong.cn/media/css/fz.css" rel="stylesheet">
<link rel="stylesheet" href="https://www.bwrong.cn/styles/main.css">
<script type="text/javascript">
function getCSS()
{
        datetoday = new Date();
        timenow=datetoday.getTime();
        datetoday.setTime(timenow);
        thehour = datetoday.getHours();

        if (thehour<5)

            display = "https://www.bwrong.cn/media/css/night.css";

       else if (thehour>20)

            display = "https://www.bwrong.cn/media/css/night.css";

        else if (thehour>5)
     
            display = "https://www.bwrong.cn/media/css/day.css";

        else if (thehour<20)

            display = "https://www.bwrong.cn/media/css/day.css";


var css = '<';
        css+='link rel="stylesheet" href='+display+' \/';
        css+='>';
        document.write(css);
}
</script>
<link href="https://at.alicdn.com/t/font_1306644_ko4c4at97is.css" rel="stylesheet" />
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://www.bwrong.cn/media/css/katex.min.css">
<script type='text/javascript' src='https://www.bwrong.cn/media/scripts/script.js'></script>
<link href="https://cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet" />
  <script src="https://cdn.bootcss.com/wow/1.1.2/wow.min.js"></script>
  <script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script>wow=new WOW({boxClass:'wow',animateClass:'animated',offset:0,mobile:true,live:true});wow.init();</script>

<script type="text/javascript">
window.onload=getCSS();
</script>
<!-- 百度统计 -->
<script>
var _hmt = _hmt || [];
(function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?2c0e9e3f54ae20480b34c178578c4df8";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
})();
</script>


</head>
<body class="post-template-default single single-post postid-70 single-format-standard">
    <div id="wrapper">

	
<header id="header" class="site-header"
		
		style="background-image: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)),url(https://www.bwrong.cn/post-images/dev-tools05.jpg)"
		
		>
			<div class="site-branding">
									<h1 class="site-title"><a href="https://www.bwrong.cn" rel="home">BWrong的小站</a></h1>

					<h2 class="site-description">天青色等烟雨，而我在等你</h2>

							</div>
			<nav id="nav-wrapper">
				<div class="container">
					<div class="nav-toggle">
						<div class="bars">
							<div class="bar"></div>
							<div class="bar"></div>
							<div class="bar"></div>
						</div>
					</div>
					<div class="clear"></div>
					<ul id="" class="dove">
		 

<li>

	
		<a href="/">
		  首页
		</a>
	  

    

<li>

	
		<a href="/archives/index.html">
		  归档
		</a>
	  

    

<li>

	
		<a href="/post/about/">
		  关于
		</a>
	  

    

</ul>
</li>

</ul>				</div>
			</nav>
						<div class="jingge">


    

    

<a  href="https://github.com/BWrong" target="_blank" ><i class="iconfont icon-github"></i></a>
 
    

    

    

    

<a  href="https://juejin.cn/user/3421335914820280" target="_blank" ><i class="iconfont icon-telegram"></i></a>
 
    

    

    

    

    

    
        </header>


		<div id="content" class="container">
			<div class="row">
	<div class="col-md-8 site-main">

<article id="post-70" class="post-70 post type-post status-publish format-standard hentry category-5 tag-10 tag-9 tag-11">



		<div class="entry-content">
			<h1 data-wow-delay="0.4s"  class="wow fadeInUp entry-title">【前端工程化】篇五 未来已来-Babel</h1>
<div class="entry-meta">
<div class="wow fadeInUp"  data-wow-delay="0.6s">
	<i class="iconfont icon-rili"> <time class="lately-a" datetime="2021-01-27 15:22:22" itemprop="datePublished" pubdate="">2021-01-27</time></i>
	          </div>

</span>

		</div>

			<div class="wow fadeInUp entry-summary song"  data-wow-delay="0.1s">
				<p>字数：4627， 阅读时间：12分钟，点击<a href="https://www.bwrong.cn/post/dev-tools05/">阅读原文</a></p>
<blockquote>
<p>枫林新叶催陈叶，雏凤清于老风声。 一一李商隐</p>
</blockquote>
<p>【前端工程化】系列文章链接：</p>
<ul>
<li><a href="https://www.bwrong.cn/post/dev-tools01/">01 扬帆起航-开发环境</a></li>
<li><a href="https://www.bwrong.cn/post/dev-tools02/">02 白璧微瑕-包管理器</a></li>
<li><a href="https://www.bwrong.cn/post/dev-tools03/">03 席卷八荒-Webpack基础篇</a></li>
<li><a href="https://www.bwrong.cn/post/dev-tools04/">04 席卷八荒-Webpack进阶篇</a></li>
</ul>
<p><em>示例代码仓库：<a href="https://github.com/BWrong/dev-tools">https://github.com/BWrong/dev-tools</a></em></p>
<p><em>声明：如按照文中代码执行报错，请检查依赖版本是否和示例代码仓库中一致。</em></p>
<h1 id="概述">概述</h1>
<p>作为一个有追求的前端，如果你没有听过<a href="https://babeljs.io/"><code>Babel</code></a>的大名，那就真的是out了。不过说实话不太了解Babel的话，其实对日常开发的影响也不大，因为很多脚手架已经配置好了，不用自己折腾。但是如果你想玩转前端工程化这块，这就是绕不过的坎。</p>
<p>babel官方定义为一款<code>JavaSscript</code>编译器。</p>
<blockquote>
<p>Use next generation JavaScript, today.</p>
<p>现在就使用下一代JavaScript语法吧</p>
</blockquote>
<p>这里的“下一代”是泛指新的、暂时还不被浏览器广泛支持的，而不是局限于某个确定的版本。</p>
<p>简单来说，浏览器（特别是一些低端浏览器，说你呢IE）对ECMAScript规范的支持是滞后的，新的语法虽然能够给我们带来更好的编程体验，却奈何往往不能不能直接在用户的浏览器运行，所以就需要在浏览器运行这些代码前将其转换成支持的语法，而Babel就是负责这个的，当然它的能力远不止如此，后面我们一一道来。</p>
<p>Babel主要做的就是这几点：</p>
<ul>
<li>语法转换：将新的语法转换成兼容性更好的旧语法。</li>
<li>特性垫片：通过<code>Polyfill</code> 实现目标环境中缺少的特性，将环境的特性差异垫平，说白了还是做兼容。</li>
<li>more...</li>
</ul>
<pre><code class="language-js">// Babel Input: ES2015 arrow function
[1, 2, 3].map((n) =&gt; n + 1);

// Babel Output: ES5 equivalent
[1, 2, 3].map(function(n) {
  return n + 1;
});
</code></pre>
<h2 id="运行方式">运行方式</h2>
<p>Babel的运行过程分为三个阶段：解析 --- 转换 ---  生成</p>
<figure data-type="image" tabindex="1"><img src="https://gitee.com/letwrong/Picture/raw/master/20200904114027.png" alt="" loading="lazy"></figure>
<ol>
<li>解析：解析代码，并生成AST抽象语法树</li>
<li>转换：将上一步的AST转换成目标环境支持的AST</li>
<li>生成：根据转换后的AST生成目标代码</li>
</ol>
<p>不难发现，第二步就是Babel执行的核心操作。但Babel自身是不具备任何转换能力，必须借助一些插件来实现语法的转换。关于插件，后续会详细介绍，这里只需记住，插件赋予了babel强大的能力，没有插件它算个球。</p>
<p>如果想了解具体的转换过程，请阅读<a href="https://juejin.im/post/5ab35c3cf265da23771951a2">从babel讲到AST</a>。</p>
<blockquote>
<p>babel解析语法的内核使用的是<code>babylon</code>，现在已更名为<code>@babel/parser</code>。</p>
</blockquote>
<h2 id="babel7">Babel7</h2>
<p>作者在写这篇文章的时候，babel的版本是<code>7.10.0</code>，<code>babel7</code>带来了很多新的特性，为了避免给大家造成误导，这里先列出babel7的变化，避免和之前版本的配置混淆。</p>
<p>主要的变化如下：</p>
<ul>
<li>preset：推荐使用 <code>env</code>替代<code>es201x</code>；删除<code>stage-x</code> ，因为这些草案中的特性不稳定，维护这些preset会浪费大量精力，所以官方放弃了。如果需要使用可以自己显式的添加对应的插件。</li>
<li>npm包名：将所有<code>babel-*</code>更改为<code>@babel/*</code>，更加符合npm命名规范。
<ul>
<li><code>babel-cli</code> -&gt; <code>@babel/cli</code>。</li>
<li><code>babel-preset-env</code> -&gt; <code>@babel/preset-env</code>，简写为 <code>@babel/env</code></li>
</ul>
</li>
<li>对低于nodejs6.0不再提供支持。</li>
<li><code>@babel/cli</code>中不再包含<code>@babel/node</code>，如要使用需要单独安装。</li>
<li>提供<code>babel-upgrade</code>帮助开发者从6到7的版本升级。</li>
</ul>
<h1 id="使用和配置">使用和配置</h1>
<h2 id="使用方式">使用方式</h2>
<p>babel的使用场景主要分为两种：命令行和构建工具。</p>
<ul>
<li>命令行</li>
</ul>
<p>babel为命令行提供了<code>@babel/cli</code>工具，支持在命令行直接执行babel命令。</p>
<p>首先，安装必要的包：</p>
<pre><code class="language-shell">npm install --save-dev @babel/core @babel/cli
</code></pre>
<blockquote>
<p>这里必须要安装<code>@babel/core</code>，它是babel的<strong>核心</strong>，它是后续一切的基石，无论哪种方式都必不可少。</p>
</blockquote>
<p>安装好在项目中执行<code>babel</code>命令就可以进行转换了。</p>
<pre><code class="language-shell">babel src --out-dir lib # 将src下的文件处理后输出到lib
</code></pre>
<ul>
<li>
<p>构建系统</p>
<p>在构建工具中使用才是我们使用babel更常用的方式。这里我们以webpack为例。</p>
<p>babel提供了一个loader：<code>babel-loader</code>，使用这个loader我们就能很轻松实现代码转换。</p>
</li>
</ul>
<pre><code class="language-js">module: {
  rules: [
    {
      test: /\.js$/,
      loader: 'babel-loader',
      options: {
      	// 配置项
      }
    }
  ]
}

</code></pre>
<ul>
<li>
<p>运行时（不推荐）</p>
<p>babel还提供了运行时环境下的处理，可以在代码运行时，实时进行转换。不过并不推荐这种方式，因为它是在代码运行时实时进行转换，效率较低。</p>
<p>除了以上方式，还有一些其他的使用方式，详情可以查看<a href="https://babel.docschina.org/setup#installation">babel配置</a>。</p>
</li>
</ul>
<h2 id="配置文件">配置文件</h2>
<p>前面的方式我们都没有提供配置，所以输出和输入是一样的，这完全没有意义。所以我们一般会提供一些配置，来告诉babel如何进行转换。</p>
<p>babel7支持多种方式来进行配置：</p>
<ul>
<li>
<p><a href="https://babel.dev/docs/en/configuration#babelconfigjson"><code>babel.config.json</code></a>（项目范围）</p>
</li>
<li>
<p><a href="https://babel.dev/docs/en/configuration#babelrcjson"><code>.babelrc.json</code></a>（相对文件）</p>
</li>
<li>
<p><code>package.json</code>中添加babel字段</p>
</li>
</ul>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;my-package&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;babel&quot;: {
    &quot;presets&quot;: [ ... ],
    &quot;plugins&quot;: [ ... ],
  }
}
</code></pre>
<p>前面两种配置文件都使用了json格式，其实babel还支持其他格式，如 <code>.js</code>，<code>.cjs</code>（Commonjs）和<code>.mjs</code>（ESModule），它们相对于json格式更加灵活，可以在配置中进行编程处理，但是会使配置无法静态分析，失去可缓存性。</p>
<pre><code class="language-js">// babel.config.js
module.exports = {
  presets: [],
  plugins: []
};

</code></pre>
<p>所有方式的配置内容都是类似的，我们可以根据自己的使用场景进行灵活选择。</p>
<p>babel虽然有多种方式来写配置文件，但是配置的内容都是类似的，主要包含<code>plugins</code>和<code>presets</code>两部分，不过这里需要注意几点：</p>
<ul>
<li>
<p>配置格式：<code>plugins</code>和<code>presets</code>配置项均为数组，如果每项不需要配置的话，直接放入数组（值为项的字符串名称）；如果要配置的话，则需要把格式改成数组，该数组的第一个元素是该项的字符串名字，第二个元素是该项的配置对象。</p>
<p><em>这里填写的plugins和presets，babel会自动检查是否已被安装在<code>node_modules</code>下面，当然，也可以使用相对路径来使用本地文件。</em></p>
</li>
</ul>
<pre><code class="language-json">&quot;plugins&quot;: [
    [
      &quot;component&quot;,
      {
        &quot;libraryName&quot;: &quot;element-ui&quot;,
        &quot;styleLibraryName&quot;: &quot;theme-chalk&quot;
      }
    ],
    &quot;@babel/plugin-transform-runtime&quot;
 ]
</code></pre>
<ul>
<li>
<p>执行顺序：<strong><code>plugins</code>会从前到后执行，<code>presets</code>会从后向前执行，且<code>plugins</code>会比<code>presets</code>先执行</strong></p>
<p><code>presets</code>逆序执行的目的是为了保证向后兼容，我们在配置的时候按照规范的时间顺序列出即可，如<code>['es2015', 'stage-1']</code>，这样就会先使用<code>stage-1</code>，否则就会出现错误。</p>
</li>
<li>
<p>短名称：在配置plugin和preset名字的时候，可以省略名字中的<code>babel-plugin-</code>和<code>preset-</code>字样，仅使用插件的名字就可以了。</p>
</li>
</ul>
<pre><code class="language-json">{
  &quot;plugins&quot;: [
    &quot;myPlugin&quot;, // 完整名字：&quot;babel-plugin-myPlugin&quot;
    &quot;@org/myPlugin&quot; // 完整名字：&quot;@org/babel-plugin-myPlugin&quot;
  ],
  &quot;presets&quot;:[
    &quot;myPreset&quot;, // 完整名字：&quot;babel-preset-myPreset&quot;
    &quot;@babel/myPreset&quot; // 完整名字：@babel/preset-myPreset
  ]
}
</code></pre>
<p>关于一些常用<code>plugins</code>和<code>presets</code>的常用配置，我们在下面会有详细介绍。</p>
<h1 id="核心">核心</h1>
<p>babel的核心除了<code>@babel/core</code>就是<code>plugins</code>和<code>presets</code>了，我们一般使用babel其实就是在折腾这两块内容。下面我们就来一探究竟。</p>
<h2 id="plugin">Plugin</h2>
<p>前面我们说了，babel的转换完全依靠插件，babel拥有的能力完全取决于给它配置了哪些插件。</p>
<p>babel的插件分为两种：</p>
<ul>
<li>
<p>语法插件：赋予babel解析特定语法的能力，可以理解一个为babel服务的翻译官，仅做翻译解析工作，工作在<code>AST</code>转换阶段。</p>
</li>
<li>
<p>转译插件：转译插件即把特定的语法转换成指定标准的语法。</p>
<p>比如将箭头函数 <code>(x) =&gt; x</code> 转换成 <code>function (x) {return x}</code>，只需要配置箭头函数转译插件即可。</p>
</li>
</ul>
<pre><code class="language-json">{
  &quot;plugins&quot;: [
    &quot;@babel/plugin-transform-arrow-functions&quot;
  ]
}
</code></pre>
<blockquote>
<p>**注意：**使用了转译插件，就不再需要配置对应的语法插件了，因为转译插件会自动启用相应的语法插件。其实很容易理解，连解析都做不到，又何谈转换呢。</p>
</blockquote>
<p>插件的使用大概分为两步：</p>
<ol>
<li>将插件添加到配置文件的<code>plugins</code>属性中，可根据插件文档做相应配置。</li>
<li>安装插件到项目中，使用npm或者yarn均可</li>
</ol>
<p>每个插件的功能是单一的，所以一般转换需求要使用的插件数量比较多，这时候可以考虑presets。常用的插件和用法可以查看<a href="https://babeljs.io/docs/en/plugins">babel-plugins</a></p>
<h3 id="自定义插件">自定义插件</h3>
<p>除了使用社区提供的插件，我们也可以自己开发。</p>
<pre><code class="language-js">module.exports = function() {
  return {
    visitor: {
      Identifier(path) {
        const name = path.node.name;
        // reverse the name: JavaScript -&gt; tpircSavaJ
        path.node.name = name
          .split(&quot;&quot;)
          .reverse()
          .join(&quot;&quot;);
      },
    },
  };
}
</code></pre>
<p>这里只是一个简单的例子，实际的插件开发远不是如此简单，可以执行查看<a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md">Babel 插件手册</a>学习。</p>
<h2 id="presets">Presets</h2>
<p>在实际的开发中，我们如果用ES6来进行开发的话，那需要转换的语法是非常多的，难道要一个一个去配置吗？还要不要配陪妹子了？</p>
<p>这个时候，就该presets登场了。presets可以理解为一组插件的集合，就像你去德克士直接点一个全家桶，而不必一个一个给服务员说要鸡腿、鸡翅、薯条...（如果想和服务员小姐姐多待一会，也不是不可以）</p>
<p>presets的来源主要有以下几种途径：</p>
<ul>
<li>
<p>官方：官方为常用的环境提供了preset。</p>
<ul>
<li><a href="https://babel.docschina.org/docs/en/babel-preset-env">@babel/preset-env</a></li>
<li><a href="https://babel.docschina.org/docs/en/babel-preset-flow">@babel/preset-flow</a></li>
<li><a href="https://babel.docschina.org/docs/en/babel-preset-react">@babel/preset-react</a></li>
<li><a href="https://babel.docschina.org/docs/en/babel-preset-typescript">@babel/preset-typescript</a></li>
<li>stage-X (试验性 Presets)</li>
</ul>
</li>
<li>
<p>社区：在npm上面可以找到许多社区维护的<a href="https://www.npmjs.com/search?q=babel-preset">preset</a>，比如vue和react都有维护了自己的preset。</p>
</li>
<li>
<p>自定义：在有特殊需求的时候，可以自己创建preset。</p>
</li>
</ul>
<pre><code class="language-js">module.exports = () =&gt; ({
  presets: [ // 引用其他preset
    require(&quot;@babel/preset-env&quot;),
  ],
  plugins: [ // 要集合的插件
    [require(&quot;@babel/plugin-proposal-class-properties&quot;), { loose: true }],
    require(&quot;@babel/plugin-proposal-object-rest-spread&quot;),
  ],
});
</code></pre>
<p><strong>注意：</strong><a href="%5Bhttps://babel.docschina.org/docs/en/presets#stage-x-%E8%AF%95%E9%AA%8C%E6%80%A7-presets%5D(https://babel.docschina.org/docs/en/presets#stage-x-%E8%AF%95%E9%AA%8C%E6%80%A7-presets)">Stage-x</a> presets 中的任何转换都是针对未发布的 Javascript 特性（如 ES6 / ES2015）的更改，都是不稳定的，将来这些提案可能会发生变化，请谨慎使用，特别是第三阶段前的提案。从v7开始，所有针对标准提案阶段的功能所编写的预设(stage preset)都已被弃用，官方已经移除了 <code>@babel/preset-stage-x</code>。</p>
<h4 id="babelpreset-env">@babel/preset-env</h4>
<pre><code class="language-json">{
    &quot;presets&quot;: [&quot;@babel/preset-env&quot;]
}
</code></pre>
<p>这个是我们最常用的，也是官方现在推荐的preset，它是一个智能预设，我们无需再关心特定环境下所需的转换插件（只需要指定目标环境），就可以使用最新的语法。除了能够减少使用难度，还能够使转换出来的代码体积更小。</p>
<p>preset-env会根据配置的目标环境中缺少的功能，选择对应的插件进行必要的转换和<code>polyfill</code>，而目标环境支持的特性就不会转换，而不是无脑的一把梭哈。</p>
<p>如果不进行配置，它将使用默认配置，即 latest（<a href="https://github.com/babel/babel-preset-env/blob/master/data/plugin-features.js">env维护的插件列表</a>），会将最新的JS特性(ES2015,ES2016...，不包含 stage 阶段)，将其转换成ES5代码。所以如果使用了提案阶段的语法，则需要自行额外配置。</p>
<h5 id="如何指定目标环境">如何指定目标环境</h5>
<ul>
<li>配置文件：通过配置文件的targets属性指定目标环境</li>
</ul>
<pre><code class="language-json">{
  &quot;presets&quot;: [
    [&quot;env&quot;, {
      &quot;targets&quot;: {
        &quot;browsers&quot;: [&quot;last 2 versions&quot;, &quot;safari &gt;= 7&quot;],
        &quot;node&quot;: &quot;12.10&quot;
      }
    }]
  ]
}
</code></pre>
<ul>
<li>
<p>browserslistrc：如果是浏览器或者<code>Electron</code>，官方推荐使用<code>.browserslistrc</code>文件来指定目标环境（可以和autoprefixer、stylelint等其他工具共享配置）。</p>
<p>不过如果在配置文件中设置了 <code>targets</code> 或 <code>ignoreBrowserslistConfig</code>，<code>.browserslistrc</code>中配置的内容将不会生效。</p>
</li>
</ul>
<pre><code class="language-shell"># .browserslistrc
last 2 Chrome versions
</code></pre>
<p>具体用法请查看<a href="https://github.com/browserslist/browserslist"><code>browserslist</code> 的更多配置</a>。</p>
<h5 id="其他配置">其他配置</h5>
<p>除了<code>targets</code>外，还有一些配置项也比较常用：</p>
<ul>
<li>
<p>modules: 用于指定转换后的模块规范，可设置为<code>&quot;amd&quot; | &quot;umd&quot; | &quot;systemjs&quot; | &quot;commonjs&quot; | &quot;cjs&quot; | &quot;auto&quot; | false</code>，默认为<code>&quot;auto&quot;</code>。</p>
</li>
<li>
<p><code>useBuiltIns</code>：此选项配置如何<code>@babel/preset-env</code>处理polyfill，在后面介绍polyfill我们会详细介绍。</p>
</li>
<li>
<p><code>corejs</code>：用于指定corejs的版本，仅当使用了<code>useBuiltIns: usage</code>或者<code>useBuiltIns: entry</code>此配置才有效，使用时一定要配置正确的版本，否则会报错。</p>
<p>当前默认的版本是<code>2.0</code>，不过建议使用<code>3.0</code>版本，因为2.0已经不会再添加新的特性了，如果使用了一些较新的语法，将会无法转换。</p>
</li>
</ul>
<p>除了上述配置，还有一些不常用的配置，可以查看<a href="https://babeljs.io/docs/en/babel-preset-env#options">官方文档</a>。</p>
<h1 id="polyfill">Polyfill</h1>
<p>前面我们的配置其实是不完美的，转换出来的代码直接在浏览器运行是可能会出问题的。这是因为babel默认只转换了语法，而对于一些新的API是并没有处理的，如Generator、Set、Maps、Proxy、Promise 等全局对象及其方法都不会转码，如果我们在代码中使用到了就会报错。</p>
<p>此时，我们就需要做Polyfill，也就是所谓的'垫片'，作用就是把浏览器的差异垫平，人话就是通过模拟为这些浏览器补全缺失的全局对象及API。</p>
<h3 id="babelpolyfill废弃">@babel/polyfill（废弃）</h3>
<p>早期的方案就是<code>@babel/polyfill</code>（早期的名字是<code>babel-polyfill</code>，内部集成了 <code>core-js</code> 和 <code>regenerator</code>），在入口或者webpack配置的entry中引入<code>@babel/polyfill</code>，此工具会模拟完整的ES2015 +环境（不包含第4阶段的提议），会创建一些全局对象，或者在已有全局对象的原型上补全方法，让我们可以使用<code>Promise</code>、<code>WeakMap</code>、<code>Array.from</code>等新的API。</p>
<blockquote>
<p>比如<code>Array.prototype.includes</code>是ES6的API，就会在<code>Array.prototype</code>上面添加一个自己实现的includes方法来模拟原生的includes。</p>
</blockquote>
<pre><code class="language-js">import '@babel/polyfill';
let include = [1,2,3].includes(1);
new Promise((resolve, reject) =&gt; {
    resolve();
});
</code></pre>
<p>现在，我们的代码就可以在低版本的浏览器运行了。不过此方案有一些缺点：</p>
<ul>
<li>文件体积大：因为<code>@babel/polyfill</code>会把所有API都补全，不管你有没有使用，比如你可能在项目中只使用了一个新的API，结果他给你梭哈了，把所有的API都整进去了。所以最后打出来的包会非常大，非常浪费。</li>
<li>污染全局变量：<code>@babel/polyfill</code>会在全局创建对象或者修改全局对象的原型链，所以会对全局变量进行污染。</li>
</ul>
<p>对于第一个缺点，我们可以使用前面<code>@babel/preset-env</code>提供的<code>useBuiltIns</code>配置，当设置为<code>usage</code>时（须要制定corejs版本），babel会检查我们的代码，只引入我们代码中需要的<code>polyfill</code>，这样打包出来的文件就会小很多。</p>
<pre><code class="language-json">// babel.config.json
{
  &quot;presets&quot;: [
    [
      &quot;@babel/env&quot;,
      {
        &quot;useBuiltIns&quot;: &quot;usage&quot;,
        &quot;corejs&quot;: 3
      }
    ]
  ]
}

</code></pre>
<p>例如前面的代码：</p>
<pre><code class="language-js">// import '@babel/polyfill';  使用useBuiltIns: 'usage'时，会自动导入需要的垫片，所以不用再手动引入
let include = [1,2,3].includes(1);
new Promise((resolve, reject) =&gt; {
    resolve();
});
</code></pre>
<p>编译后的代码：</p>
<pre><code class="language-js">&quot;use strict&quot;;
require(&quot;core-js/modules/es.array.includes&quot;);
require(&quot;core-js/modules/es.object.to-string&quot;);
require(&quot;core-js/modules/es.promise&quot;);

// import '@babel/polyfill';
let include = [1,2,3].includes(1);
new Promise((resolve, reject) =&gt; {
    resolve();
});
</code></pre>
<p>我们可以看到，在文件的头部仅加入了文件中用到的新语法的<code>polyfill</code>，是不是棒棒的了。</p>
<p>不过这并没有完，试想如果很多文件都使用了这些特性，岂不是每个文件都会引入一次，有没有办法改善一下呢？</p>
<h3 id="babelplugin-transform-runtime"><code>@babel/plugin-transform-runtime</code></h3>
<p><code>@babel/plugin-transform-runtime</code> 是一个可重复使用Babel注入的帮助程序的插件，避免重复注入，以节省代码大小。通常还要搭配<code>@babel/runtime</code>一起使用。</p>
<pre><code class="language-shell">npm install --save-dev @babel/plugin-transform-runtime
npm install --save @babel/runtime # 提供缺失的特性，须要在生产环境中安装
</code></pre>
<pre><code class="language-json">// babel.config.json
{
  &quot;presets&quot;: [
    [
      &quot;@babel/preset-env&quot;,
      {
        &quot;useBuiltIns&quot;: &quot;usage&quot;,
        &quot;corejs&quot;: 3
      }
    ]
  ],
  &quot;plugins&quot;: [[&quot;@babel/plugin-transform-runtime&quot;]]
}

</code></pre>
<p>如上配置后，一个class转换如下：</p>
<pre><code class="language-js">// 源码
class Foo {
  method() {}
}
</code></pre>
<pre><code class="language-js">// 转换后
import _classCallCheck from &quot;babel-runtime/helpers/classCallCheck&quot;;
import _createClass from &quot;babel-runtime/helpers/createClass&quot;;

let Foo = function () {
  function Foo() {
    _classCallCheck(this, Foo);
  }

  _createClass(Foo, [{
    key: &quot;method&quot;,
    value: function method() {}
  }]);

  return Foo;
}();
</code></pre>
<p>我们看到，这里并不是采用全局引入的方式，而是引入了局部变量来替换新的语法，提供了一个沙箱机制，这就顺便解决了上面全局作用域污染的问题。而且这里所有模拟的特性都是从<code>@babel/runtime</code>中引入，而这个包我们是安装在生产环境中的，并不是会打包到每个文件中，这就使这些<code>polyfill</code>得到了复用，不会打包多次。</p>
<p>**注意：**上面的corejs需要为3.0才会完全转换，如果使用2.0只会转换语法，而不会做<code>polyfill</code>，如果要做的话需要再单独引入<code>@babel/runtime-corejs3</code>来进行处理，推荐使用3.0，所以这里不再赘述。</p>
<p>经历了一波三折，我们终于搞定了。但是，这不是银弹，未来可能还会出现其他的方案，关于Polyfill的历史可以去看云谦大佬的<a href="https://github.com/sorrycc/blog/issues/80">Polyfill 方案的过去、现在和未来</a>。</p>
<h1 id="生态">生态</h1>
<p>除了上面介绍的东西，babel生态也是非常繁荣，还有很多其他配套的一些工具（名字通常以<code>babel-*</code>或<code>@babel/*</code>开头），下面我们大概列举一下：</p>
<ul>
<li><code>babel-cli</code>：babel提供的命令行工具，提供了<code>babel</code>命令来执行编译任务。</li>
<li><code>babel-register</code>：会在<code>require</code>加载文件前，先用babel进行转码编译，前面说到的运行时编译就是使用此工具。</li>
<li><code>babel-loader</code>：babel为webpack提供的一个loader，也是最常见的使用方式。可以在webpack构建的工程中进行转码编译。</li>
<li><code>babel-polyfill</code>/<code>@babel/polyfill</code>：babel提供的polyfill工具。</li>
</ul>
<p>babel的存在，让我们可以打破运行环境语法规范的限制，犹如一台时光机，把我们带到了未来，让我们可以用彼时的语法来编写此时的应用，为我们学习和使用最新的语法扫清了障碍，俨然babel已成为我们工程化中必不可少的一个工具。</p>
<p>参考文档：<a href="https://babel.docschina.org/">Babel中文网</a>、<a href="https://juejin.im/post/5ddff3abe51d4502d56bd143#heading-6">不容错过的 Babel7 知识</a>、<a href="https://juejin.im/post/5c19c5e0e51d4502a232c1c6#heading-12">一口(很长的)气了解 babel</a></p>

							</div>
	<div class="wow fadeInUp vt-post-tags">
 
				<a href="https://www.bwrong.cn/tag/nDb9M_8Zn/" rel="tag">babel</a>
				 
					</div>
<nav class="navigation3 post-navigation3" role="navigation">

		<div class="nav-links3">
      
		<div class="wow fadeInUp nav-previous3"><a href="https://www.bwrong.cn/post/dfvWZp8Jg/" rel="prev"> 【转】你不一定要逆风翻盘，但请一定向阳而生</a></div>
		 
		 
		<div class="wow fadeInUp nav-next3"><a href="https://www.bwrong.cn/post/dev-tools04/" rel="next"> 【前端工程化】篇四 席卷八荒-Webpack（进阶）</a></div>
		
		</div>
	</nav>
	<div class="wow fadeInUp author-info">
	<div class="author-avatar pull-left"><img src="https://www.bwrong.cn/images/avatar.png" ></div>
 
	<div class="author-description"><div class="author-title"><div class="author-link" rel="author">BWrong</div></div>


	<p class="author-bio">愿你走出半生，归来仍是少年</p></div></div>
	
		</div>



</article>

<div id="marlin_lite_about_widget-2" class="wow fadeInUp widget marlin_lite_about_widget" data-wow-delay="0.1s">

        
		<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://www.bwrong.cn/media/scripts/Valine.min.js'></script>

<div class="comment"></div>
<script>
        new Valine({
            av: AV,
            el: '.comment',
            lang: 'zh-cn',
            visitor: false, // 阅读量统计
            
            admin_email:'wang11535041@qq.com',
            
            
            emoticon_url: '/media/alu',
             
      emoticon_list: ["吐.png","喷血.png","狂汗.png","不说话.png","汗.png","坐等.png","献花.png","不高兴.png","中刀.png","害羞.png","皱眉.png","小眼睛.png","中指.png","尴尬.png","瞅你.png","想一想.png","中枪.png","得意.png","肿包.png","扇耳光.png","亲亲.png","惊喜.png","脸红.png","无所谓.png","便便.png","愤怒.png","蜡烛.png","献黄瓜.png","内伤.png","投降.png","观察.png","看不见.png","击掌.png","抠鼻.png","邪恶.png","看热闹.png","口水.png","抽烟.png","锁眉.png","装大款.png","吐舌.png","无奈.png","长草.png","赞一个.png","呲牙.png","无语.png","阴暗.png","不出所料.png","咽气.png","期待.png","高兴.png","吐血倒地.png","哭泣.png","欢呼.png","黑线.png","喜极而泣.png","喷水.png","深思.png","鼓掌.png","暗地观察.png"],
     
      app_id: 'jaz3TfUjRowK9fOMAPb9yw6i-MdYXbMMI',
      
      
      app_key: 'pbltxx4rElIP1RStL3AwujSp',
         
          
      placeholder: '欢迎你留下足迹'
       
        });
    </script>





		</div>

			</div>
			


<div class="tocc col l3 hide-on-med-and-down">

        <div class="toc-widget">

            <div class="toc-title"></div>

            <div id="toc-content">


			</div>
        </div>
    </div>


<script src="https://www.bwrong.cn/media/scripts/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '.entry-summary',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1,h2' //**
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('.entry-summary').children('h1, h2').each(function () {/**/
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget').parent();
        // let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>






			</div>
		</div>


		 <footer id="colophon" class="site-footer">

	<div class="container">

		<div class="copyright"> <br>Theme: <a
				href="https://github.com/alterfang/gridea-theme-pan" target="_blank" title="Pan"><span>Pan</span></a>.
			Powered by <a href="https://gridea.dev/" target="_blank" title="Gridea"><span>Gridea</span></a> . 版权所有：<a href="https://beian.miit.gov.cn/" target="_blank"><span>蜀ICP备2023018303号-1</span></a></div>
	</div>

</footer>
		<!-- loding -->
		<div class="loader">
			<div class="loader-content">
				<div class="songjingge">
					<span></span>
					<span></span>
					<span></span>
					<span></span>
					<span></span>
				</div>
			</div>
		</div>
<script id="rendered-js">
	window.onload = function () {
			var loader = document.getElementsByClassName("loader")[0];
			loader.className = "loader fadeout"; //使用渐隐的方法淡出loading page
			setTimeout(function () {
				loader.style.display = "none";
			}, 0);
	};
</script>


</div>

<script src="https://cdn.bootcss.com/fitvids/1.2.0/jquery.fitvids.min.js"></script>
<script type='text/javascript' src='https://www.bwrong.cn/media/scripts/marlin-scripts.js'></script>
<script src="https://www.bwrong.cn/media/scripts/lately.min.js"></script>
<script>jQuery(document).ready(function () { $.lately({ 'target': '.lately-a,.lately-b,.lately-c' }) });</script>
<style type="text/css">
  a.back_to_top {
    text-decoration: none;
    position: fixed;
    bottom: 40px;
    right: 30px;
    background: #f0f0f0;
    height: 40px;
    width: 40px;
    border-radius: 50%;
    line-height: 36px;
    font-size: 18px;
    text-align: center;
    transition-duration: .5s;
    transition-propety: background-color;
    display: none;
  }

  a.back_to_top span {
    color: #888;
  }

  a.back_to_top:hover {
    cursor: pointer;
    background: #dfdfdf;
  }

  a.back_to_top:hover span {
    color: #555;
  }

  @media print,
  screen and (max-width: 580px) {
    .back_to_top {
      display: none !important;
    }
  }
</style><a id="back_to_top" href="#" class="back_to_top"><span><i class="iconfont icon-xiangshang"></i></span>
</a>

<script>
$(document).ready((function (_this) {
    return function () {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function () {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block');
          } else {
            return bt.css('display', 'none');
          }
        });
        return bt.click(function () {
          $('body,html').animate({
            scrollTop: 0
          }, 800);
          return false;
        });
      }
    };
  })(this));
//   $(window).load(function () {
//     //异步延迟加载样式
//     var link = $('<link />');
//     link.attr('href', 'https://fonts.googleapis.com/css?family=Dancing+Script|Noto+Sans+SC:300|Montserrat&display=swap');
//     link.attr('rel', 'stylesheet');
//     link.appendTo($('head'));
// });
</script>

<!-- 宠物 -->
<canvas id="live2dcanvas" width="200" height="400" class="live2d"></canvas>
<style>
  #live2dcanvas {
    position: fixed;
    right: 0px;
    z-index: 999;
    pointer-events: none;
    bottom: -40px;
    width: 200px;
    height: 400px;
  }

  @media (max-width: 768px) {
    #live2dcanvas {
      width: 150px;
      height: 300px;
    }
  }

  @media (max-width: 639px) {
    #live2dcanvas {
      display: none !important;
    }
  }
</style>
<script src="https://www.bwrong.cn/media/scripts/L2Dwidget.min.js"></script>
<script>
  //初始化小人物 需设置属性pluginRootPath: "live2dw/"指明资源跟路径
  L2Dwidget.init({
    pluginRootPath: "media/",//资源root路径
    pluginJsPath: "scripts/",//js相对root的路径
    pluginModelPath: "model/",//模型相对root的路径
    tagMode: !1,
    debug: !1,
    model: {
      scale: 2,
      jsonPath: "/media/model/live2d-widget-model-epsilon/Epsilon2.1.model.json"
    },
    display: {//大小位置什么的自己慢慢调就是了
      position: "right",//定位
      width: 130,//宽度
      height: 210,//高度
      hOffset: -40,//左右
      vOffset: 0//上下
    },
    mobile: {
      show: !1
    },
    log: !1
  });
</script>
<!-- 宠物结束 -->

		<script data-no-instant>
    // (function ($) {
    //     $.extend({
    //         adamsOverload: function () {
    //             $('.navigation:eq(0)').remove();
    //             $("").attr("rel" , "external");
    //             $("a[rel='external'],a[rel='external nofollow']").attr("target","_blank");
    //             $("a.vi").attr("rel" , "");
    //             $.viewImage({
    //                 'target'  : 'img',
    //                 'exclude' : '.vsmile-icons img,.gallery img',
    //                 'delay'   : 300
    //             });
    //             $.lately({
    //                 'target' : '.commentmetadata a,.infos time,.post-list time'
	// 			});
	// 			console.log(prettyPrint)
	// 			if(prettyPrint) prettyPrint();

    //             $('ul.links li a').each(function(){
    //                 if($(this).parent().find('.bg').length==0){
    //                     $(this).parent().append('<!---<div class="bg" style="background-image:url(https://c3.glgoo.top/s2/favicons?domain='+$(this).attr("href")+')"></div>--->')
    //                 }
    //             });
    //         }
    //     });
    // })(jQuery);
	// jQuery.adamsOverload();

    (function ($) {
        $.extend({
            adamsOverload: function () {
                $.viewImage({
                    'target'  : '.song img',
                    'exclude' : '.vsmile-icons img',
                    'delay'   : 300
                });
            }
        });
    })(jQuery);
    jQuery.adamsOverload();
</script>

</body>
</html>
